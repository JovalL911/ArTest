<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>A-Frame AR â€” Floor Place Rectangle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- A-Frame 1.7.0 (inkl. WebXR / AR / ar-hit-test) -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

    <script>
      /**
       * place-once
       * - Wartet auf das erste ar-hit-test-select Event (Tap in AR)
       * - Setzt die Karte auf die Position des Reticles
       * - Schaltet den Hit-Test danach ab (Objekt bleibt "verankert")
       */
      AFRAME.registerComponent('place-once', {
        schema: { reticle: { type: 'selector' } },

        init() {
          this.placed = false;
          this.onSelect = this.onSelect.bind(this);
          this.el.sceneEl.addEventListener('ar-hit-test-select', this.onSelect);
        },

        remove() {
          this.el.sceneEl.removeEventListener('ar-hit-test-select', this.onSelect);
        },

        onSelect() {
          const reticle = this.data.reticle;
          if (this.placed || !reticle || !reticle.object3D.visible) return;

          // Position & Rotation vom Reticle Ã¼bernehmen
          this.el.object3D.position.copy(reticle.object3D.position);
          this.el.object3D.quaternion.copy(reticle.object3D.quaternion);

          // Karte anzeigen und merken, dass sie platziert wurde
          this.el.setAttribute('visible', true);
          this.placed = true;

          // Hit-Test abschalten und Reticle ausblenden
          this.el.sceneEl.setAttribute('ar-hit-test', 'enabled: false');
          reticle.setAttribute('visible', false);

          // Overlay-Hinweis verstecken
          const hint = document.getElementById('hint');
          if (hint) hint.style.display = 'none';
        }
      });

      /**
       * ui-button
       * - Einfacher Klick-Handler fÃ¼r dein AR-Button-Plane
       * - Hier kannst du spÃ¤ter Navigation, API-Calls etc. einbauen
       */
      AFRAME.registerComponent('ui-button', {
        schema: { label: { default: 'Press' } },
        init() {
          this.el.addEventListener('click', () => {
            alert('Button clicked!');
          });
        }
      });

      /**
       * ar-hints
       * - KÃ¼mmert sich um die Text-Hinweise wÃ¤hrend der AR-Session
       * - Reagiert auf Events des ar-hit-test Components
       */
      AFRAME.registerComponent('ar-hints', {
        init() {
          const scene = this.el.sceneEl;
          const hint = document.getElementById('hint');
          const reticle = document.getElementById('reticle');

          if (!hint || !reticle) return;

          // Wenn AR gestartet wird
          scene.addEventListener('enter-vr', () => {
            if (!scene.is('ar-mode')) return;
            hint.style.display = 'block';
            hint.textContent = 'Bewege dein Smartphone, um eine FlÃ¤che zu finden â€¦';
          });

          // Hit-Test hat eine FlÃ¤che gefunden
          scene.addEventListener('ar-hit-test-achieved', () => {
            hint.textContent = 'Tippe auf den Bildschirm, um die Karte zu platzieren.';
            reticle.setAttribute('visible', true);
          });

          // Karte wurde platziert (place-once blendet den Hinweis zusÃ¤tzlich aus)
          scene.addEventListener('ar-hit-test-select', () => {
            hint.textContent = 'Karte platziert ðŸŽ‰';
          });

          // Wenn AR wieder verlassen wird
          scene.addEventListener('exit-vr', () => {
            reticle.setAttribute('visible', false);
            hint.style.display = 'none';
          });
        }
      });
    </script>

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      }

      /* DOM-Overlay fÃ¼r Text-Hinweise */
      #overlayUI {
        position: fixed;
        inset: 0;
        pointer-events: none;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 16px;
      }

      #hint {
        pointer-events: none;
        background: rgba(0, 0, 0, 0.55);
        color: #fff;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        backdrop-filter: blur(6px);
      }
    </style>
  </head>

  <body>
    <!-- AR-Overlay Hinweistext (UI bleibt auch im AR-Modus sichtbar dank dom-overlay) -->
    <div id="overlayUI">
      <div id="hint">Tippe unten rechts auf â€žARâ€œ, um die Kamera zu starten.</div>
    </div>

    <!--
      A-Frame AR Szene
      - webxr: aktiviert AR-Modus + Hit-Test + DOM Overlay
      - xr-mode-ui: zeigt explizit nur den AR-Button an
      - ar-hit-test: aktualisiert das Reticle (target:#reticle) bei erkannter FlÃ¤che
      - cursor + raycaster: erlauben Screen-Tap-Interaktion mit .clickable
    -->
    <a-scene
      renderer="colorManagement: true; physicallyCorrectLights: true"
      webxr="mode: ar;
             referenceSpaceType: local;
             requiredFeatures: hit-test;
             optionalFeatures: dom-overlay;
             overlayElement: #overlayUI"
      xr-mode-ui="XRMode: ar; enterAREnabled: true"
      ar-hit-test="target: #reticle; type: transient"
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable"
      ar-hints>

      <!-- Beleuchtung (wirkt auf dein virtuelles UI-Panel) -->
      <a-entity light="type: hemisphere; intensity: 0.8; groundColor: #777"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="0 3 1"></a-entity>

      <!-- Kamera in AR (keine Controls nÃ¶tig, die Pose kommt von WebXR) -->
      <a-entity camera look-controls="enabled: false"></a-entity>

      <!-- Reticle, das vom ar-hit-test Component positioniert wird -->
      <a-entity id="reticle" visible="false">
        <a-ring
          radius-inner="0.045"
          radius-outer="0.06"
          rotation="-90 0 0"
          material="color: #00BCD4; opacity: 0.95">
        </a-ring>

        <a-cylinder
          height="0.001"
          radius="0.03"
          rotation="-90 0 0"
          material="color: #00BCD4; opacity: 0.35">
        </a-cylinder>
      </a-entity>

      <!--
        Karte / Panel
        - Start: unsichtbar
        - Wird beim ersten Tap an die Reticle-Position gesetzt (place-once)
      -->
      <a-entity
        id="card"
        visible="false"
        place-once="reticle: #reticle"
        position="0 0 -0.5"
        rotation="-90 0 0">

        <!-- HintergrundflÃ¤che der Karte -->
        <a-plane
          width="0.32"
          height="0.18"
          material="color: #ffffff; opacity: 0.98; metalness: 0; roughness: 1"
          shadow="cast: true; receive: true">
        </a-plane>

        <!-- Titel -->
        <a-text
          value="Hello AR ðŸ‘‹"
          align="center"
          color="#111"
          position="0 0.055 0.001"
          width="0.5">
        </a-text>

        <!-- Untertitel -->
        <a-text
          value="Placed on your floor"
          align="center"
          color="#333"
          position="0 0.02 0.001"
          width="0.5">
        </a-text>

        <!-- Button (clickable) -->
        <a-plane
          class="clickable"
          ui-button="label: Open"
          position="0 -0.045 0.001"
          width="0.18"
          height="0.045"
          material="color: #0ea5e9">

          <a-text
            value="Open"
            align="center"
            color="#fff"
            width="0.4"
            position="0 0 0.001">
          </a-text>
        </a-plane>
      </a-entity>
    </a-scene>
  </body>
</html>

