<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>A-Frame AR â€” Floor Place Rectangle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- A-Frame 1.7.0 (inkl. WebXR / AR / ar-hit-test) -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-ar-hit-test-component@1.1.0/dist/aframe-ar-hit-test-component.min.js"></script>

    <script>
      /**
       * ar-hints
       * - Zeigt dynamisch Hinweise zum Status des Hit-Tests im Overlay an
       * - ErklÃ¤rt, wie man eine geeignete FlÃ¤che findet (Licht, Textur, Bewegung)
       */
      AFRAME.registerComponent('ar-hints', {
        init() {
          this.hintEl = document.getElementById('hint');
          this.reticle = document.getElementById('reticle');
          this.card = document.getElementById('card');
          this.hitStatusBar = document.getElementById('hitStatusBar');
          this.hitStatusEl = document.getElementById('hitStatus');
          this.scene = this.el.sceneEl;
          this.scanInterval = null;
          this.rescanTimeout = null;
          this.rescanPending = false;

          this.onEnterVR = this.onEnterVR.bind(this);
          this.onHitTestStart = this.onHitTestStart.bind(this);
          this.onHitTestAchieved = this.onHitTestAchieved.bind(this);
          this.onHitTestSelect = this.onHitTestSelect.bind(this);
          this.onHitTestUnavailable = this.onHitTestUnavailable.bind(this);
          this.onHitTestError = this.onHitTestError.bind(this);
          this.onExitVR = this.onExitVR.bind(this);
          this.onDoubleClick = this.onDoubleClick.bind(this);

          this.scene.addEventListener('enter-vr', this.onEnterVR);
          this.scene.addEventListener('ar-hit-test-start', this.onHitTestStart);
          this.scene.addEventListener('ar-hit-test-achieved', this.onHitTestAchieved);
          this.scene.addEventListener('ar-hit-test-select', this.onHitTestSelect);
          this.scene.addEventListener('ar-hit-test-unavailable', this.onHitTestUnavailable);
          this.scene.addEventListener('ar-hit-test-error', this.onHitTestError);
          this.scene.addEventListener('exit-vr', this.onExitVR);
          document.addEventListener('dblclick', this.onDoubleClick);
        },

        remove() {
          this.scene.removeEventListener('enter-vr', this.onEnterVR);
          this.scene.removeEventListener('ar-hit-test-start', this.onHitTestStart);
          this.scene.removeEventListener('ar-hit-test-achieved', this.onHitTestAchieved);
          this.scene.removeEventListener('ar-hit-test-select', this.onHitTestSelect);
          this.scene.removeEventListener('ar-hit-test-unavailable', this.onHitTestUnavailable);
          this.scene.removeEventListener('ar-hit-test-error', this.onHitTestError);
          this.scene.removeEventListener('exit-vr', this.onExitVR);
          document.removeEventListener('dblclick', this.onDoubleClick);
        },

        updateHint(text, show = true) {
          if (!this.hintEl) return;
          this.hintEl.textContent = text;
          this.hintEl.style.display = show ? 'block' : 'none';
        },

        updateHitStatus(text, show = true) {
          if (!this.hitStatusEl || !this.hitStatusBar) return;
          this.hitStatusEl.textContent = text;
          this.hitStatusBar.style.display = show ? 'flex' : 'none';
          this.hitStatusEl.style.display = show ? 'flex' : 'none';
        },

        startScanningHint() {
          this.stopScanningHint();
          this.updateHint(
            'AR gestartet â€“ suche eine ebene, gut beleuchtete FlÃ¤che. Bewege das GerÃ¤t langsam in einer â€ž8â€œ, bis ein blaues Ziel auftaucht.'
          );

          // Alle paar Sekunden Erinnerung einblenden, damit der Screen nicht "leer" wirkt.
          this.scanInterval = setInterval(() => {
            this.updateHint(
              'Scanne weiterâ€¦ halte die Kamera auf eine strukturierte FlÃ¤che (Tisch, Boden) gerichtet und bewege dich leicht, bis das Ziel erscheint.'
            );
          }, 4500);
        },

        stopScanningHint() {
          if (this.scanInterval) {
            clearInterval(this.scanInterval);
            this.scanInterval = null;
          }
          if (this.rescanTimeout) {
            clearTimeout(this.rescanTimeout);
            this.rescanTimeout = null;
          }
          this.rescanPending = false;
        },

        toggleReticle(visible) {
          if (this.reticle) {
            this.reticle.setAttribute('visible', visible);
          }
        },

        onEnterVR() {
          if (!this.scene.is('ar-mode')) return;

          this.startScanningHint();
          this.toggleReticle(false);
          this.updateHitStatus('nichts gefunden');
        },

        onDoubleClick() {
          if (!this.scene.is('ar-mode')) {
            this.updateHint('AR noch nicht aktiv â€“ tippe unten rechts auf â€žARâ€œ, um zu starten.');
            return;
          }

          this.restartScan();
        },

        restartScan() {
          this.rescanPending = true;
          this.toggleReticle(false);
          this.resetPlacement();
          this.startScanningHint();
          this.updateHint('Neuscan gestartetâ€¦ suche erneut nach einer ebenen FlÃ¤che.');
          this.updateHitStatus('nichts gefunden');

          this.scene.emit('ar-hit-test-start');

          this.rescanTimeout = setTimeout(() => {
            if (!this.rescanPending) return;
            this.updateHint(
              'Keine neue FlÃ¤che gefunden. Bewege die Kamera leicht und stelle sicher, dass der Bereich gut beleuchtet ist.'
            );
            this.rescanPending = false;
          }, 8000);
        },

        resetPlacement() {
          if (!this.card) return;
          this.card.setAttribute('visible', false);

          const placeOnce = this.card.components['place-once'];
          if (placeOnce) {
            placeOnce.placed = false;
          }
        },

        onHitTestStart() {
          this.startScanningHint();
          this.toggleReticle(false);
          this.updateHitStatus('nichts gefunden');
        },

        onHitTestAchieved() {
          this.stopScanningHint();
          const message = this.rescanPending
            ? 'Neuscan erfolgreich âœ… Tippe auf den Bildschirm, um die Karte neu zu platzieren.'
            : 'FlÃ¤che erkannt âœ… Tippe auf den Bildschirm, um die Karte dort abzulegen.';
          this.updateHint(message);
          this.rescanPending = false;
          this.toggleReticle(true);
          this.updateHitStatus('YES, hab etwas.');
        },

        onHitTestSelect() {
          this.stopScanningHint();
          this.updateHint('Karte platziert ðŸŽ‰ Die FlÃ¤che bleibt verankert, bewege die Kamera ruhig weiter.');
          this.toggleReticle(false);
          this.updateHitStatus('YES, hab etwas.');
        },

        onHitTestUnavailable() {
          this.stopScanningHint();
          this.updateHint('Hit-Test nicht verfÃ¼gbar auf diesem GerÃ¤t/Browser. PrÃ¼fe WebXR- und Kamera-Support.');
          this.toggleReticle(false);
          this.updateHitStatus('nichts gefunden');
        },

        onHitTestError() {
          this.stopScanningHint();
          this.updateHint('Hit-Test Fehler. Erlaube Kamera- und Bewegungssensoren und stelle ausreichende Beleuchtung sicher.');
          this.toggleReticle(false);
          this.updateHitStatus('nichts gefunden');
        },

        onExitVR() {
          this.stopScanningHint();
          this.toggleReticle(false);
          this.updateHint('Tippe unten rechts auf â€žARâ€œ, um die Kamera zu starten.', false);
          this.updateHitStatus('nichts gefunden', false);
        }
      });

      /**
       * place-once
       * - Wartet auf das erste ar-hit-test-select Event (Tap in AR)
       * - Setzt die Karte auf die Position des Reticles
       * - Schaltet den Hit-Test danach ab (Objekt bleibt "verankert")
       */
      AFRAME.registerComponent('place-once', {
        schema: { reticle: { type: 'selector' } },

        init() {
          this.placed = false;
          this.onSelect = this.onSelect.bind(this);
          this.el.sceneEl.addEventListener('ar-hit-test-select', this.onSelect);
        },

        remove() {
          this.el.sceneEl.removeEventListener('ar-hit-test-select', this.onSelect);
        },

        onSelect() {
          const reticle = this.data.reticle;
          if (this.placed || !reticle || !reticle.object3D.visible) return;

          // Position und Rotation der Karte auf die des Reticles setzen
          this.el.object3D.position.copy(reticle.object3D.position);
          this.el.object3D.quaternion.copy(reticle.object3D.quaternion);
          this.el.setAttribute('visible', true);

          this.placed = true;
          reticle.setAttribute('visible', false);
        }
      });

      /**
       * ar-debug
       * - Protokolliert wichtige AR- und Hit-Test-Ereignisse
       * - Schreibt in die Konsole und in das Debug-Panel unten links
       */
      AFRAME.registerComponent('ar-debug', {
        init() {
          this.statusEl = document.getElementById('status');
          this.statusLog = document.getElementById('statusLog');
          this.log('Scene initialized, waiting for AR sessionâ€¦');

          const scene = this.el.sceneEl;
          const events = [
            ['enter-vr', 'XR session started'],
            ['exit-vr', 'XR session ended'],
            ['ar-hit-test-start', 'Hit-test started'],
            ['ar-hit-test-achieved', 'Surface found'],
            ['ar-hit-test-select', 'Placement tap received'],
            ['ar-hit-test-error', 'Hit-test error: check console'],
            ['ar-hit-test-unavailable', 'Hit-test unavailable on device'],
          ];
          events.forEach(([event, message]) => {
            scene.addEventListener(event, () => this.log(message));
          });
        },

        log(message) {
          console.info(`[AR DEBUG] ${message}`);
          if (this.statusEl) {
            const now = new Date().toLocaleTimeString();
            this.statusEl.textContent = `${now} â€” ${message}`;
          }

          if (this.statusLog) {
            const now = new Date().toLocaleTimeString();
            const entry = document.createElement('li');
            entry.textContent = `${now} â€” ${message}`;
            this.statusLog.appendChild(entry);

            while (this.statusLog.children.length > 8) {
              this.statusLog.removeChild(this.statusLog.firstChild);
            }
          }
        }
      });
    </script>

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        background: #0b1724;
        color: #e2e8f0;
      }

      /* Overlay oben fÃ¼r kompaktes Hit-Test-Feedback */
      #hitStatusBar {
        position: fixed;
        top: 12px;
        left: 0;
        right: 0;
        display: none;
        justify-content: center;
        pointer-events: none;
      }

      #hitStatus {
        background: rgba(11, 23, 36, 0.8);
        color: #e2e8f0;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 600;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
        letter-spacing: 0.02em;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      /* DOM-Overlay fÃ¼r Text-Hinweise */
      #overlayUI {
        position: fixed;
        inset: 0;
        pointer-events: none;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 16px;
      }

      #hint {
        pointer-events: none;
        background: rgba(0, 0, 0, 0.55);
        color: #fff;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        backdrop-filter: blur(6px);
        max-width: min(480px, 90vw);
        text-align: center;
        line-height: 1.45;
      }

      #debugPanel {
        position: fixed;
        left: 12px;
        bottom: 12px;
        background: rgba(0, 0, 0, 0.65);
        color: #e2e8f0;
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 12px;
        max-width: 320px;
        line-height: 1.4;
        pointer-events: none;
        backdrop-filter: blur(6px);
      }

      #statusLog {
        margin: 8px 0 0;
        padding-left: 16px;
        max-height: 160px;
        overflow: auto;
      }

      #statusLog li {
        margin-bottom: 4px;
      }
    </style>
  </head>
  <body>
    <div id="hitStatusBar" aria-live="polite">
      <div id="hitStatus">nichts gefunden</div>
    </div>

    <div id="overlayUI" aria-live="polite">
      <div id="hint">Tippe unten rechts auf â€žARâ€œ, um die Kamera zu starten.</div>
    </div>

    <div id="debugPanel">
      <strong>AR Status:</strong>
      <div id="status">Scene initialized</div>
      <ul id="statusLog"></ul>
    </div>

    <!--
      A-Frame AR Szene
      - webxr: aktiviert AR-Modus + Hit-Test + DOM Overlay
      - xr-mode-ui: zeigt explizit nur den AR-Button an
      - ar-hit-test: aktualisiert das Reticle (target:#reticle) bei erkannter FlÃ¤che
      - cursor + raycaster: erlauben Screen-Tap-Interaktion mit .clickable
    -->
    <a-scene
      renderer="colorManagement: true; physicallyCorrectLights: true"
      webxr="mode: ar;
             referenceSpaceType: local;
             requiredFeatures: hit-test;
             optionalFeatures: dom-overlay;
             overlayElement: #overlayUI"
      xr-mode-ui="XRMode: ar; enterAREnabled: true"
      ar-hit-test="target: #reticle; type: transient"
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable" 
      ar-hints
      ar-debug>

      <!-- Beleuchtung (wirkt auf dein virtuelles UI-Panel) -->
      <a-entity light="type: hemisphere; intensity: 0.8; groundColor: #777"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="0 3 1"></a-entity>

      <!-- Kamera in AR (keine Controls nÃ¶tig, die Pose kommt von WebXR) -->
      <a-entity camera look-controls="enabled: false"></a-entity>

      <!-- Reticle, das vom ar-hit-test Component positioniert wird -->
      <a-entity id="reticle" visible="false">
        <a-ring
          radius-inner="0.45"
          radius-outer="0.50"
          rotation="-90 0 0"
          material="color: #00bcd4; opacity: 0.95">
        </a-ring>

        <a-cylinder
          height="0.01"
          radius="0.40"
          rotation="-90 0 0"
          material="color: #00bcd4; opacity: 0.35">
        </a-cylinder>
      </a-entity>

      <!-- Deine "Karte" als leichtes UI-Panel -->
      <a-entity
        id="card"
        class="clickable"
        visible="false"
        geometry="primitive: plane; width: 0.55; height: 0.32"
        material="color: #0ea5e9; opacity: 0.92; roughness: 0.35; metalness: 0.1"
        text="value: AR Surface Demo; align: center; width: 1.5; color: #e0f2fe; wrapCount: 18"
        position="0 -10 0"
        place-once="reticle: #reticle">
        <a-entity
          geometry="primitive: plane; width: 0.5; height: 0.28"
          material="color: #020617; opacity: 0.6"
          position="0 0 0.001">
        </a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
