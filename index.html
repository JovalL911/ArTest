<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>A-Frame AR â€” Floor Place Rectangle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- A-Frame 1.7.0 (inkl. WebXR / AR / ar-hit-test) -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-ar-hit-test-component@1.1.0/dist/aframe-ar-hit-test-component.min.js"></script>

    <script>
      /**
       * place-once
       * - Wartet auf das erste ar-hit-test-select Event (Tap in AR)
       * - Setzt die Karte auf die Position des Reticles
       * - Schaltet den Hit-Test danach ab (Objekt bleibt "verankert")
       */
      AFRAME.registerComponent('place-once', {
        schema: { reticle: { type: 'selector' } },

        init() {
          this.placed = false;
          this.onSelect = this.onSelect.bind(this);
          this.el.sceneEl.addEventListener('ar-hit-test-select', this.onSelect);
        },

        remove() {
          this.el.sceneEl.removeEventListener('ar-hit-test-select', this.onSelect);
        },

        onSelect() {
          const reticle = this.data.reticle;
          if (this.placed || !reticle || !reticle.object3D.visible) return;

@@ -80,106 +81,205 @@
          // Wenn AR gestartet wird
          scene.addEventListener('enter-vr', () => {
            if (!scene.is('ar-mode')) return;
            hint.style.display = 'block';
            hint.textContent = 'Bewege dein Smartphone, um eine FlÃ¤che zu finden â€¦';
          });

          // Hit-Test hat eine FlÃ¤che gefunden
          scene.addEventListener('ar-hit-test-achieved', () => {
            hint.textContent = 'Tippe auf den Bildschirm, um die Karte zu platzieren.';
            reticle.setAttribute('visible', true);
          });

          // Karte wurde platziert (place-once blendet den Hinweis zusÃ¤tzlich aus)
          scene.addEventListener('ar-hit-test-select', () => {
            hint.textContent = 'Karte platziert ðŸŽ‰';
          });

          // Wenn AR wieder verlassen wird
          scene.addEventListener('exit-vr', () => {
            reticle.setAttribute('visible', false);
            hint.style.display = 'none';
          });
        }
      });

      /**
       * ar-debug
       * - Protokolliert wichtige AR- und Hit-Test-Ereignisse
       * - Schreibt in die Konsole und in das Debug-Panel unten links
       */
      AFRAME.registerComponent('ar-debug', {
        init() {
          this.statusEl = document.getElementById('status');
          this.statusLog = document.getElementById('statusLog');
          this.log('Scene initialized, waiting for AR sessionâ€¦');

          const scene = this.el.sceneEl;
          const events = [
            ['enter-vr', 'XR session started'],
            ['exit-vr', 'XR session ended'],
            ['ar-hit-test-start', 'Hit-test started'],
            ['ar-hit-test-achieved', 'Surface found'],
            ['ar-hit-test-select', 'Placement tap received'],
            ['ar-hit-test-error', 'Hit-test error: check console'],
            ['ar-hit-test-unavailable', 'Hit-test unavailable on device'],
          ];

          events.forEach(([name, message]) => {
            scene.addEventListener(name, () => this.log(message));
          });

          if (!AFRAME.components['ar-hit-test']) {
            this.log('ar-hit-test component not loaded â€“ check the script include.');
          }

          if (!navigator.xr) {
            this.log('WebXR not available in this browser.');
          } else {
            navigator.xr.isSessionSupported('immersive-ar')
              .then((supported) => {
                this.log(supported ? 'AR supported: tap the AR button to start.' : 'AR not supported on this device/browser.');
              })
              .catch((err) => this.log(`AR support check failed: ${err.message}`));
          }

          const isSecure = window.isSecureContext || location.hostname === 'localhost';
          if (!isSecure) {
            this.log('Warning: WebXR requires HTTPS. Open this page via https:// or localhost.');
          }
        },

        log(message) {
          console.info(`[AR DEBUG] ${message}`);
          if (this.statusEl) {
            const now = new Date().toLocaleTimeString();
            this.statusEl.textContent = `${now} â€” ${message}`;
          }

          if (this.statusLog) {
            const now = new Date().toLocaleTimeString();
            const entry = document.createElement('li');
            entry.textContent = `${now} â€” ${message}`;
            this.statusLog.appendChild(entry);

            while (this.statusLog.children.length > 8) {
              this.statusLog.removeChild(this.statusLog.firstChild);
            }
          }
        }
      });
    </script>

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      }

      /* DOM-Overlay fÃ¼r Text-Hinweise */
      #overlayUI {
        position: fixed;
        inset: 0;
        pointer-events: none;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 16px;
      }

      #hint {
        pointer-events: none;
        background: rgba(0, 0, 0, 0.55);
        color: #fff;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        backdrop-filter: blur(6px);
      }

      #debugPanel {
        position: fixed;
        left: 12px;
        bottom: 12px;
        background: rgba(0, 0, 0, 0.65);
        color: #e2e8f0;
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 12px;
        max-width: 320px;
        line-height: 1.4;
        pointer-events: none;
        backdrop-filter: blur(6px);
      }

      #statusLog {
        margin: 8px 0 0;
        padding-left: 16px;
        max-height: 160px;
        overflow: auto;
      }

      #statusLog li {
        margin-bottom: 4px;
      }
    </style>
  </head>

  <body>
    <!-- AR-Overlay Hinweistext (UI bleibt auch im AR-Modus sichtbar dank dom-overlay) -->
    <div id="overlayUI">
      <div id="hint">Tippe unten rechts auf â€žARâ€œ, um die Kamera zu starten.</div>
    </div>

    <div id="debugPanel">
      <strong>AR Status:</strong>
      <div id="status">Scene initialized</div>
      <ul id="statusLog"></ul>
    </div>

    <!--
      A-Frame AR Szene
      - webxr: aktiviert AR-Modus + Hit-Test + DOM Overlay
      - xr-mode-ui: zeigt explizit nur den AR-Button an
      - ar-hit-test: aktualisiert das Reticle (target:#reticle) bei erkannter FlÃ¤che
      - cursor + raycaster: erlauben Screen-Tap-Interaktion mit .clickable
    -->
    <a-scene
      renderer="colorManagement: true; physicallyCorrectLights: true"
      webxr="mode: ar;
             referenceSpaceType: local;
             requiredFeatures: hit-test;
             optionalFeatures: dom-overlay;
             overlayElement: #overlayUI"
      xr-mode-ui="XRMode: ar; enterAREnabled: true"
      ar-hit-test="target: #reticle; type: transient"
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable"
      ar-hints>
      ar-hints
      ar-debug>

      <!-- Beleuchtung (wirkt auf dein virtuelles UI-Panel) -->
      <a-entity light="type: hemisphere; intensity: 0.8; groundColor: #777"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="0 3 1"></a-entity>

      <!-- Kamera in AR (keine Controls nÃ¶tig, die Pose kommt von WebXR) -->
      <a-entity camera look-controls="enabled: false"></a-entity>

      <!-- Reticle, das vom ar-hit-test Component positioniert wird -->
      <a-entity id="reticle" visible="false">
        <a-ring
          radius-inner="0.045"
          radius-outer="0.06"
          rotation="-90 0 0"
          material="color: #00BCD4; opacity: 0.95">
        </a-ring>

        <a-cylinder
          height="0.001"
          radius="0.03"
          rotation="-90 0 0"
          material="color: #00BCD4; opacity: 0.35">
        </a-cylinder>
      </a-entity>
